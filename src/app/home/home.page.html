<ion-header class="ion-no-border header-glass">
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-button (click)="onClick()">
                <ion-icon name="location-outline"></ion-icon>
                <ion-label class="btn-label">Seleccionar localidad</ion-label>
            </ion-button>
        </ion-buttons>

        <ion-buttons slot="end">
            <ion-button fill="clear" (click)="onClick()">
                <ion-icon name="chevron-forward-outline"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="home">
    <!-- Background -->
    <div class="bg" [ngStyle]="{ 'background-image': 'url(' + imagen + ')' }"></div>
    <div class="bg-overlay"></div>

    <ion-refresher slot="fixed" (ionRefresh)="refrescar($event)">
        <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    <div class="page">
        <!-- Top greeting -->
        <div class="topbar">
            <div class="topbar__left">
                <div class="saludo">{{ saludo }}</div>
                <div class="localidad">{{ localidadLabel }}</div>
            </div>

            <div class="topbar__right">
                <img class="wx-icon" [src]="icono" alt="Icono clima" (error)="imgError($event)" />
            </div>
        </div>

        <!-- Main card -->
        <div class="card hero">
            <div class="hero__row">
                <div class="hero__temp">
                    <div class="temp">
                        {{ dato?.temp_af | number: '1.0-1' }}Â°C
                        <span class="est-badge" *ngIf="estimated?.temp">â€¢ (e)</span>
                    </div>

                    <div class="date">
                        {{ diaSemana | uppercase }} {{ dia }} DE {{ nombreMes | uppercase }} {{ anio }}
                    </div>
                </div>

                <div class="hero__pin" aria-hidden="true">
                    <ion-icon name="location"></ion-icon>
                </div>
            </div>

            <div class="hero__stats">
                <div class="stat">
                    <ion-icon name="water-outline"></ion-icon>
                    <div class="stat__value">
                        {{ dato?.hum_af }} %
                        <span class="est-dot" *ngIf="estimated?.hum">â€¢ (e)</span>
                    </div>
                </div>

                <div class="stat wind-stat">
                    <ion-icon name="leaf-outline"></ion-icon>

                    <div class="stat__value">
                        <span class="wind">

                            <span class="wind__speed">{{ dato?.viento_medio | number: '1.0-0' }} km/h</span>

                            <ion-icon class="wind__arrow" name="navigate-outline"
                                [style.transform]="vientoRotationDeg != null ? 'rotate(' + vientoRotationDeg + 'deg)' : null"
                                aria-hidden="true"></ion-icon>

                            <span class="wind__dir" *ngIf="vientoDirText">Â· {{ vientoDirText }}</span>
                        </span>

                        <span class="est-dot" *ngIf="estimated?.wind">â€¢ (e)</span>
                    </div>
                </div>


                <div class="stat">
                    <ion-icon name="compass-outline"></ion-icon>
                    <div class="stat__value">
                        {{ dato?.presion }} hPa
                        <span class="est-dot" *ngIf="estimated?.pres">â€¢ (e)</span>
                    </div>
                </div>

                <!-- lluvia diaria -->
                <div class="stat">
                    <ion-icon name="rainy-outline"></ion-icon>
                    <div class="stat__value">
                        {{ dato?.RR_dia }} mm
                        <span class="est-dot" *ngIf="estimated?.rain">â€¢ rev</span>
                    </div>
                </div>
            </div>

            <!-- ðŸ‘‡ SOLO aparece si ALGÃšN dato es estimado -->
            <div class="stat__value"
                *ngIf="estimated?.temp || estimated?.hum || estimated?.wind || estimated?.pres || estimated?.rain">
                <span class="est-dot">â€¢(e): estimada por falta de datos</span>
            </div>
        </div>

        <!-- Recommendation -->
        <button class="card reco" type="button" (click)="verDetalleAplicacion()">
            <div class="reco__left">
                <div class="reco__icon" [class.ok]="aplicarOk" [class.bad]="!aplicarOk">
                    <ion-icon [name]="aplicarOk ? 'checkmark-circle' : 'warning'"></ion-icon>
                </div>

                <div class="reco__text">
                    <div class="reco__title">{{ aplicarTexto }}</div>
                    <div class="reco__sub">
                        <ng-container *ngIf="aplicarMotivos?.length; else okText">
                            {{ aplicarMotivos.join(' Â· ') }}
                        </ng-container>
                        <ng-template #okText>Condiciones dentro de rangos permitidos.</ng-template>
                    </div>
                </div>
            </div>

            <div class="reco__chev" aria-hidden="true">
                <ion-icon name="chevron-forward-outline"></ion-icon>
            </div>
        </button>

        <!-- Hour -->
        <div class="clock">{{ hora }} HS</div>

        <!-- Alerts -->
        <div class="card section">
            <div class="section__head">
                <div class="section__title alert-title">
                    <span>ALERTA SMN Â· {{ alertasVisibles?.[0]?.area || 'TucumÃ¡n' }}</span>

                    <a class="smn-link" href="https://www.smn.gob.ar/" target="_blank" rel="noopener">
                        <img src="../../assets/images/smn.png" alt="SMN" />
                    </a>
                </div>

                <button class="link" type="button" (click)="showAlertsAll = !showAlertsAll" *ngIf="alertas?.length">
                    {{ showAlertsAll ? 'Ver menos' : 'Ver completo' }}
                    <ion-icon name="chevron-forward-outline"></ion-icon>
                </button>
            </div>

            <div class="alerts" *ngIf="alertas?.length; else noAlerts">
                <div class="alert" *ngFor="let a of alertasVisibles" (click)="verDetalleAlerta(a)" role="button"
                    tabindex="0" [ngClass]="{
            'lvl-3': a?.nivel == 3,
            'lvl-4': a?.nivel == 4,
            'lvl-5': a?.nivel == 5
          }">
                    <div class="alert__rail"></div>

                    <div class="alert__flag">
                        <ion-icon name="flag"></ion-icon>
                    </div>

                    <div class="alert__body">
                        <div class="alert__top">
                            <div class="alert__date">{{ a?.fecha }}</div>
                            <div class="alert__level">Nivel {{ a?.nivel }}</div>
                        </div>

                        <div class="alert__desc">{{ a?.descripcion || 'â€”' }}</div>
                    </div>

                    <div class="alert__chev">
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </div>
                </div>
            </div>

            <ng-template #noAlerts>
                <div class="empty">Sin alertas vigentes.</div>
            </ng-template>
        </div>

        <!-- Forecast -->
        <div class="card section">
            <div class="section__head">
                <div class="section__title forecast-title">
                    <span>PRONÃ“STICO</span>

                    <a class="owm-link" href="https://openweathermap.org/" target="_blank" rel="noopener">
                        <img src="../../assets/images/openweatherlogo.png" alt="OpenWeather" />
                    </a>
                </div>

                <button class="link" (click)="toggleForecast()" type="button">
                    {{ showForecastAll ? 'Ver menos' : 'Ver completo' }}
                    <ion-icon name="chevron-forward-outline"></ion-icon>
                </button>
            </div>

            <!-- Vista corta (hoy completo) -->
            <div class="forecast" *ngIf="!showForecastAll">
                <div class="forecast__row" *ngFor="let r of datosHShort">
                    <div class="forecast__time">{{ r[1] }}</div>

                    <div class="forecast__icon">
                        <img [src]="r[2]" (error)="imgError($event)" />
                    </div>

                    <div class="forecast__temp">{{ r[3] }}Â°</div>

                    <div class="forecast__meta">
                        <span class="pill">{{ r[4] }}%</span>
                        <span class="pill">{{ r[5] }} km/h</span>
                        <span class="forecast__descInline">{{ r[6] }}</span>
                    </div>
                </div>
            </div>

            <!-- Vista completa -->
            <div class="forecast" *ngIf="showForecastAll">
                <ng-container *ngFor="let d of forecastDias">
                    <div class="forecast__day">{{ d.label }}</div>

                    <div class="forecast__row" *ngFor="let r of d.rows">
                        <div class="forecast__time">{{ r[1] }}</div>

                        <div class="forecast__icon">
                            <img [src]="r[2]" (error)="imgError($event)" />
                        </div>

                        <div class="forecast__temp">{{ r[3] }}Â°</div>

                        <div class="forecast__meta">
                            <span class="pill">{{ r[4] }}%</span>
                            <span class="pill">{{ r[5] }} km/h</span>
                            <span class="forecast__descInline">{{ r[6] }}</span>
                        </div>
                    </div>
                </ng-container>
            </div>

            <div class="owm">OpenWeather</div>
        </div>

        <div class="spacer"></div>
    </div>
</ion-content>