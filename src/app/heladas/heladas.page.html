<!-- heladas.page.html -->
<ion-header translucent="true">
  <ion-toolbar class="topbar">
    <ion-title class="title">HELADAS</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="goLocalidades()">
        <ion-icon name="location-outline" slot="start"></ion-icon>
        <span class="stationName">{{ dato?.nombre }}</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content [fullscreen]="true" class="contenido grad">

  <!-- Resumen principal -->
  <section class="summaryCard">
    <div class="summaryTop">
      <div class="summaryLeft">
        <div class="period">{{ tituloPeriodo }}</div>

        <div class="bigTemp" *ngIf="tMin !== null; else sinDato">
          {{ fmtTemp(tMin) }} <span class="deg">°C</span>
        </div>

        <ng-template #sinDato>
          <div class="bigTemp muted">S/D</div>
        </ng-template>

        <div class="status">
          {{ estadoPrincipal }}
        </div>

        <div class="dateLine" *ngIf="modo !== 'anio'">
          {{ dia }} de {{ nombreMes }} {{ anio }}
        </div>

        <div class="dateLine" *ngIf="modo === 'anio'">
          Comparación anual ({{ anioActual }} / {{ anioPrev }})
        </div>
      </div>

      <div class="summaryRight">
        <div class="metricGrid">
          <div class="metric">
            <div class="k">FPH</div>
            <div class="v">{{ fmtDate(fphSel) }}</div>
          </div>
          <div class="metric">
            <div class="k">FUH</div>
            <div class="v">{{ fmtDate(fuhSel) }}</div>
          </div>
          <div class="metric">
            <div class="k">Hs máx.</div>
            <div class="v">{{ fmtNum(durMaxSel) }}</div>
          </div>
          <div class="metric">
            <div class="k">Hs tot.</div>
            <div class="v">{{ fmtNum(durTotalSel) }}</div>
          </div>
          <div class="metric">
            <div class="k">Días c/hel</div>
            <div class="v">{{ fmtNum(diasSel) }}</div>
          </div>
          <div class="metric">
            <div class="k">Reg.</div>
            <div class="v">{{ fmtNum(registrosSel) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acción: Mapa -->
    <button class="mapBtn" type="button" (click)="onClickHoy()">
      <img [src]="mapas" alt="Mapa" />
      <span>Mapa de heladas</span>
    </button>

    <!-- Selector de modo -->
    <div class="modeCard">
      <ion-segment class="seg" [value]="modo" (ionChange)="onModoChange($event.detail.value)">
        <ion-segment-button value="dia">
          <ion-label>HOY</ion-label>
        </ion-segment-button>
        <ion-segment-button value="mes">
          <ion-label>MES</ion-label>
        </ion-segment-button>
        <ion-segment-button value="anio">
          <ion-label>AÑO</ion-label>
        </ion-segment-button>
      </ion-segment>

      <!-- Leyenda -->
      <div class="legend">
        <span class="chip reddark">≤ -6</span>
        <span class="chip red">-5.9 a -4</span>
        <span class="chip orange">-3.9 a -2</span>
        <span class="chip warn">-1.9 a 0</span>
        <span class="chip nt">Sin helada</span>
      </div>

      <div class="legend" *ngIf="modo === 'anio'">
        <span class="legendHint">Temperatura mínima y métricas por estación</span>
      </div>
    </div>
  </section>

  <!-- Tabla / Lista -->
  <section class="tableCard" *ngIf="hayFilas; else sinFilas">
    <div class="tableTitle">
      <div class="tt">
        {{ modo === 'anio' ? ('Comparación anual (' + anioActual + ' / ' + anioPrev + ')') : 'Heladas registradas' }}
      </div>
      <div class="thint" *ngIf="modo === 'anio'">
        En “Días c/hel” y “Reg.” se muestra {{ anioActual }}/{{ anioPrev }}
      </div>
    </div>

    <!-- Header -->
    <div class="gridHeader" [class.anio]="modo === 'anio'">
      <div class="c name">NOMBRE</div>

      <ng-container *ngIf="modo === 'anio'; else headerDiaMes">
        <div class="c y">{{ anioActual }}</div>
        <div class="c y">{{ anioPrev }}</div>
        <div class="c dr">DÍAS c/hel</div>
        <div class="c dr">REG.</div>
      </ng-container>

      <ng-template #headerDiaMes>
        <div class="c y">°C</div>
        <div class="c hs">HS MÁX.</div>
        <div class="c hs">HS TOT.</div>
        <div class="c dr">DÍAS c/hel</div>
        <div class="c dr">REG.</div>
      </ng-template>
    </div>

    <!-- Rows -->
    <div class="gridRow" *ngFor="let item of rowsVisibles" [class.anio]="modo === 'anio'">
      <!-- Nombre -->
      <div class="cell name">
        {{ item?.nombre }}
      </div>

      <!-- AÑO -->
      <ng-container *ngIf="modo === 'anio'; else rowDiaMes">
        <!-- Año actual -->
        <div class="cell badge"
             [ngClass]="nivelPorTemp(item?.cur?.temperatura)">
          <div class="val">{{ fmtTemp(item?.cur?.temperatura) }}</div>
        </div>

        <!-- Año previo -->
        <div class="cell badge"
             [ngClass]="nivelPorTemp(item?.prev?.temperatura)">
          <div class="val">{{ fmtTemp(item?.prev?.temperatura) }}</div>
        </div>

        <!-- DÍAS (act/prev) -->
        <div class="cell duo">
          <div class="top">{{ fmtNum(item?.cur?.dias) }}</div>
          <div class="bot">{{ fmtNum(item?.prev?.dias) }}</div>
        </div>

        <!-- REG (act/prev) -->
        <div class="cell duo">
          <div class="top">{{ fmtNum(item?.cur?.registros) }}</div>
          <div class="bot">{{ fmtNum(item?.prev?.registros) }}</div>
        </div>
      </ng-container>

      <!-- DÍA / MES -->
      <ng-template #rowDiaMes>
        <div class="cell badge" [ngClass]="nivelPorTemp(item?.temperatura)">
          <div class="val">{{ fmtTemp(item?.temperatura) }}</div>
        </div>
        <div class="cell num">{{ fmtNum(item?.duracion) }}</div>
        <div class="cell num">{{ fmtNum(item?.duracion_t) }}</div>
        <div class="cell num">{{ fmtNum(item?.dias) }}</div>
        <div class="cell num">{{ fmtNum(item?.registros) }}</div>
      </ng-template>
    </div>

    <!-- Ver más / menos -->
    <div class="moreRow" *ngIf="(modo === 'anio' ? rowsAnio?.length : rowsDiaMes?.length) > 12">
      <ion-button fill="clear" size="small" class="moreBtn" (click)="showAll = !showAll">
        {{ showAll ? 'Ver menos' : 'Ver más' }}
      </ion-button>
    </div>
  </section>

  <ng-template #sinFilas>
    <section class="emptyCard">
      <div class="emptyTitle">Sin heladas registradas</div>
      <div class="emptyText">
        Para el período seleccionado no hay estaciones con FPH (heladas) disponibles.
      </div>
    </section>
  </ng-template>

  <!-- Hora -->
  <div id="fechayhora">
    {{ hora }} <span>HS</span>
  </div>
</ion-content>
